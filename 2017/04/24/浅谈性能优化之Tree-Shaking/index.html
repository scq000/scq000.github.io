<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>浅谈性能优化之Tree Shaking | Paolino</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">浅谈性能优化之Tree Shaking</h1><a id="logo" href="/.">Paolino</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">浅谈性能优化之Tree Shaking</h1><div class="post-meta">Apr 24, 2017</div><div class="post-content"><p>前端技术发展太快，感觉一天不努力就要被超越。这不, 最近在写Angular2练习项目的时候，遇到了一个性能优化的技术点，叫做Tree Shaking。于是，我愉快地开始了学习之旅。 </p>
<p>从技术实现上来说，它是依托于ES6提供的模块系统对代码进行<strong>静态分析</strong>,并将代码中的死代码（dead code)移除的一种技术。因此，利用Tree Shaking技术可以很方便地实现我们代码上的优化，减少代码体积。</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>随着ES6在项目中运用的越来越广泛，很多人都已经开始使用ES6自带的模块系统进行编程。现在大家写稍微复杂一点的前端项目的时候，通常都会引入多个模块，如jquery、lodash等等。而这些第三方库中的很多功能其实可能只会用到一小部分。如果按照传统的打包方式进行打包的话，你最终的代码中将会有很多的冗余代码，有损前端性能。于是，Tree Shaking应运而生。</p>
<h1 id="技术实现"><a href="#技术实现" class="headerlink" title="技术实现"></a>技术实现</h1><p>Tree Shaking，从这个技术的命名十分形象，直译过来就是“摇树”的意思。在去除代码冗余的过程中，程序会从入口文件出发扫描所有的模块依赖，以及模块的子依赖，然后将它们链接起来形成一个“抽象语法树”(AST)。随后，运行所有代码，查看哪些代码是用到过的，做好标记。最后，再将“抽象语法树”中没有用到的代码“摇落”。这样一个过程后，就去除了没有用到的代码。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/112263-4de5e694262f24b2.gif?imageMogr2/auto-orient/strip" alt="Tree Shaking"></p>
<h1 id="使用Rollup"><a href="#使用Rollup" class="headerlink" title="使用Rollup"></a>使用Rollup</h1><p>提到Tree Shaking， 就不得不谈一下<a href="https://github.com/rollup/rollup" target="_blank" rel="noopener">Rollup</a>这个库了。Tree Shaking这个术语其实就是它命名出来的。<code>Rollup</code>号称是下一代ES6的模块化工具。它支持将用ES6模块化系统写的代码打包成CMD,AMD和IFEE等多种风格的模块，从而让浏览器或node能更好地支持。并且，在打包过程中，会使用Tree Shaking技术分析代码依赖，移除冗余代码。接下来我将针对<code>Rollup</code>这个库，来讲解一下在项目实践当中它的应用。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>你用常见的npm或者目前比较流行的yarn都可以进行安装:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev rollup</span><br><span class="line"><span class="comment">//or</span></span><br><span class="line">yarn add rollup --dev</span><br></pre></td></tr></table></figure>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>Rollup的配置文件相对来说是比较简单的，对于基础的打包工作，只要指定文件路口、出口以及打包的格式之后就可以了。</p>
<p>先创建一个名为<code>rollup.config.js</code>的配置文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  entry: <span class="string">'app.js'</span>,</span><br><span class="line">  dest: <span class="string">'bundle.min.js'</span>,</span><br><span class="line">  <span class="comment">//打包格式</span></span><br><span class="line">  format: <span class="string">'umd'</span>,</span><br><span class="line">  sourceMap: <span class="literal">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行命令：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rollup -c rollup.config.js</span><br></pre></td></tr></table></figure>
<p>最后将会把<code>app.js</code>打包成<code>bundle.min.js</code>的文件。</p>
<p>Rollup官方提供了多种插件，可以实现很多个性化的需求。如：我们希望在去除代码冗余后，再使用uglify对代码进行压缩，可以使用<code>rollup-plugin-uglify</code>插件：<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uglify <span class="keyword">from</span> <span class="string">'rollup-plugin-uglify'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> default &#123;</span><br><span class="line">  ....</span><br><span class="line">  plugins: [</span><br><span class="line">    uglify()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="在Webpck-中使用Tree-Shaking"><a href="#在Webpck-中使用Tree-Shaking" class="headerlink" title="在Webpck 中使用Tree Shaking"></a>在Webpck 中使用Tree Shaking</h1><p>目前Webpack 2.0也已经开始支持Tree Shaking技术，不必再使用Rollup库了。如果需要在webpack中使用，之前可能还会用到<a href="https://github.com/araphel/babel-preset-es2015-native-modules" target="_blank" rel="noopener">babel-preset-es2015-native-modules</a>模块，但是现在只要在<code>.babelrc</code>文件中做出如下配置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">presets: [[<span class="string">"es2015"</span>, &#123; <span class="string">"modules"</span>: <span class="literal">false</span> &#125;]]</span><br></pre></td></tr></table></figure>
<p>就可以了，是不是很简单呢？</p>
<h1 id="Rollup-vs-Webpack"><a href="#Rollup-vs-Webpack" class="headerlink" title="Rollup vs Webpack"></a>Rollup vs Webpack</h1><p>另外，在我的学习过程中，曾经有一个疑问：如今Webpack已经集成了Tree Shaking，那么是否还有必要去使用Rollup呢？直到我读到了这篇文章：<a href="https://medium.com/webpack/webpack-and-rollup-the-same-but-different-a41ad427058c" target="_blank" rel="noopener">Webpack and Rollup: the same but different</a>。引用文章中的一句总结：</p>
<blockquote>
<p>Use webpack for apps, and Rollup for libraries</p>
</blockquote>
<p>Webpack和Rollup的使用场景其实不太一样。Webpack功能十分强大，主要用于解决开发复杂SPA应用时面临的许多问题：如代码分离（code splitting)、静态资源引用、模块按需加载等。但对于Rollup来说，它则更加轻量级，主要是用来构建能够被开发者广泛使用的第三方JS库的。</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>目前针对ES6的Tree Shaking技术，还不是特别成熟。特别是你需要处理的代码会产生副作用的时候，会导致Tree Shaking并不能很好地去除冗余。因此在具体的项目开发过程当中，还是建议提高代码编写的质量，减少冗余。例如利用一些工具，如eslint,jslint之类的检查策略，来删除一些没有用到的业务代码。另一方面，我们在项目中也可以采用一些进行优化过的第三方库。最后，静态导入包的过程，直接导入子模块，会比导入整个第三方库来得更合适,如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">'lodash/fp'</span>;</span><br><span class="line"><span class="comment">//BAD!</span></span><br><span class="line"><span class="keyword">import</span> &#123; map &#125; <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br></pre></td></tr></table></figure></p>
<h1 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h1><p>作为dead code elimination的一种方式，Tree Shaking目前已经集成在很多打包工具中了，大家也不妨一试。</p>
</div><div class="tags"><a href="/tags/javascript/">javascript</a><a href="/tags/性能优化/">性能优化</a></div><div class="post-nav"><a class="pre" href="/2017/07/11/React中的五种组件形式/">React中的五种组件形式</a><a class="next" href="/2017/04/08/那些年，那些跨域问题/">那些年，那些跨域问题</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var gitment = new Gitment({
  owner: 'scq000',
  repo: 'https://github.com/scq000/hexo-gitment.git',
  oauth: {
    client_id: '59f70dc7536c628210ce',
    client_secret: '59ee1a9db906805480c908772285fa5099c820c8',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/生活/" style="font-size: 15px;">生活</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/vuex/" style="font-size: 15px;">vuex</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/异步/" style="font-size: 15px;">异步</a> <a href="/tags/es6/" style="font-size: 15px;">es6</a> <a href="/tags/技术/" style="font-size: 15px;">技术</a> <a href="/tags/html/" style="font-size: 15px;">html</a> <a href="/tags/正则/" style="font-size: 15px;">正则</a> <a href="/tags/性能优化/" style="font-size: 15px;">性能优化</a> <a href="/tags/redux/" style="font-size: 15px;">redux</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/flexbox/" style="font-size: 15px;">flexbox</a> <a href="/tags/跨域/" style="font-size: 15px;">跨域</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/26/理解Redux中间件/">理解Redux中间件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/React中的五种组件形式/">React中的五种组件形式</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/24/浅谈性能优化之Tree-Shaking/">浅谈性能优化之Tree Shaking</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/08/那些年，那些跨域问题/">那些年，那些跨域问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/30/响应式图片的处理/">响应式图片的处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/09/ES6语言特性的总结-3/">ES6语言特性的总结(3)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/01/ES6语言特性的总结-2/">ES6语言特性的总结(2)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/26/ES6语言特性的总结-1/">ES6语言特性的总结(1)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/06/设计模式之状态模式/">设计模式之状态模式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/20/IOS-Input-Disabled默认样式问题/">IOS Input Disabled默认样式问题</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Paolino.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>